# Pull from jboss/base-jdk:11 image
FROM docker.io/jboss/base-jdk:11

# Set JBOSS_HOME to /opt/rh/jboss-eap-7.4
ENV JBOSS_HOME="/opt/rh/jboss-eap-7.4"

# Switch to the root user
USER root

# Create the directory /opt/rh
RUN mkdir -p /opt/rh

# Change directory to /opt/rh
WORKDIR /opt/rh

# Add all the jboss-eap-7.4.0.zip-a* parts under /tmp & assemble the bundle with the name jboss-eap-7.4.0.zip
# Unzip the jboss bundle under /opt/rh
ADD ./jboss-eap-7.4.0.zip-aa /tmp/jboss-eap-7.4.0.zip-aa
ADD ./jboss-eap-7.4.0.zip-ab /tmp/jboss-eap-7.4.0.zip-ab
ADD ./jboss-eap-7.4.0.zip-ac /tmp/jboss-eap-7.4.0.zip-ac
ADD ./jboss-eap-7.4.0.zip-ad /tmp/jboss-eap-7.4.0.zip-ad
ADD ./jboss-eap-7.4.0.zip-ae /tmp/jboss-eap-7.4.0.zip-ae

RUN cat /tmp/jboss-eap-7.4.0.zip-a* > /opt/rh/jboss-eap-7.4.0.zip && \
    unzip /opt/rh/jboss-eap-7.4.0.zip

# Add myapp.war under /opt/rh/standalone/deployments
ADD ./myapp.war ${JBOSS_HOME}/standalone/deployments/

# Change the user/group ownership of /opt/rh directory to the jboss user/group recursively
# Make sure to do some cleaning to remove unnessary files
# Make sure that the jboss user has full permissions to its directory and everyone else has only read & executable permissions to the directory
# Add a user for the application with the command "/opt/rh/bin/add-user.sh admin Passw0rd123 --silent"
# Edit /opt/rh/bin/standalone.conf and add the below line at the end of the file
# JAVA_OPTS="$JAVA_OPTS -Djboss.bind.address=0.0.0.0 -Djboss.bind.address.management=0.0.0.0"
RUN rm -rf /opt/rh/jboss-eap-7.4.0.zip && \
    rm -rf /tmp/jboss* && \
    chown -R jboss:jboss /opt/rh && \
    chmod -R 755 /opt/rh && \
    ${JBOSS_HOME}/bin/add-user.sh admin Passw0rd123 --silent && \
    echo "JAVA_OPTS=\"$JAVA_OPTS -Djboss.bind.address=0.0.0.0 -Djboss.bind.address.management=0.0.0.0\"" >> ${JBOSS_HOME}/bin/standalone.conf
    
# Switch to the jboss user
User jboss

WORKDIR ${JBOSS_HOME}/bin

# Run the command /opt/rh/bin/standalone.sh -c standalone-full-ha.xml
ENTRYPOINT ["./standalone.sh"]
CMD ["-c","standalone-full-ha.xml"]

# Publish the ports 8080, 9990, 9999 to the outside world
EXPOSE 8080 9990 9999

# Tag this image as quay.io/YOURUSERNAME/jboss-simple:simple and push it to your quay.io account.

# Run a container in detached mode named jboss-simple that publishes ports 80, 9990, 9999 as 7550, 7551, 7552 espectively. Curl all the ports.

